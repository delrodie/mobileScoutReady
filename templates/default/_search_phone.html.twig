{% extends 'base.html.twig' %}

{% block body %}
    <div
        data-controller="search-phone firebase-sms form-loader"
        data-firebase-phone-value=""
        class="d-flex justify-content-center align-items-center align-content-center vh-100"
    >
        <div class="mx-w-sm mx-auto d-flex flex-column justify-content-center align-items-center px-3">
            <img src="{{ asset('img/logo-scoutready.png') }}" alt="" class="img-fluid" style="width:250px">

            {# Statut des notifications #}
            <div class="w-100 mt-3" style="max-width: 340px;">
                <div data-search-phone-target="permissionStatus">
                    {# Sera rempli dynamiquement #}
                </div>
            </div>

            <div class="d-flex flex-column justify-content-center align-items-center mt-3">
                <p class="px-4 text-center" style="font-size: 15px;">
                    Afin d'avoir une exp√©rience utilisateur performante, il faut renseigner votre t√©l√©phone.
                </p>

                <form
                    data-search-phone-target="form"
                    data-action="submit->search-phone#submit turbo:submit-start->form-loader#disable turbo:submit-end->form-loader#enable"
                    action="{{ path('app_search_phone') }}"
                    method="post"
                >
                    <div class="position-relative mb-3 mt-4" style="max-width: 340px; width: 100%;">
                        <input type="tel"
                               name="_phone_search"
                               data-search-phone-target="phone"
                               class="form-control form-control-lg input-style ps-5"
                               id="phoneInput"
                               placeholder="Entre votre num√©ro de t√©l√©phone"
                               minlength="10" maxlength="10"
                               autocomplete="off" required>
                        <i class="bi bi-phone position-absolute top-50 start-0 translate-middle-y text-secondary fs-5 ms-1 me-5"></i>
                    </div>

                    <div id="recaptcha-container"></div>

                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('_searchPhone') }}">

                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-main btn-lg"
                                type="submit"
                                data-form-loader-target="button">
                            <span data-form-loader-target="text">Soumettre</span>
                            <div class="d-flex justify-content-center align-items-center d-none"
                                 data-form-loader-target="spinner">
                                <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                                <span data-form-loader-target="loading" class="px-3" role="status">Veuillez patienter...</span>
                            </div>
                        </button>
                    </div>
                </form>

                {# Bouton de debug pour tester les notifications #}
                <div class="mt-3 w-100" style="max-width: 340px;">
                    <button
                        class="btn btn-outline-secondary btn-sm w-100"
                        onclick="testNotificationStatus()"
                        type="button">
                        <i class="bi bi-bell"></i> V√©rifier les notifications
                    </button>
                </div>
            </div>

            <p class="fst-italic fw-light text-center mt-5 px-4" style="font-size:13px">
                NB: Le num√©ro de t√©l√©phone ne sera partag√© √† aucun membre de la communaut√© sauf aux Admins.
            </p>

            {# Info sur les notifications #}
            <div class="alert alert-info small mt-3 px-3" style="max-width: 340px;">
                <i class="bi bi-info-circle"></i>
                <strong>Notifications requises :</strong><br>
                Cette application utilise les notifications pour vous envoyer des codes de v√©rification s√©curis√©s.
            </div>
        </div>

        {# --- BLOC 2 : VERIFICATION OTP (Cach√© par d√©faut avec d-none) --- #}
        <div data-search-phone-target="otpContainer" class="d-none text-center animate__animated animate__fadeIn">
            <div class="mb-3">
                <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
                <h4 class="fw-bold">V√©rification</h4>
                <p class="text-muted small">
                    Un code a √©t√© envoy√© au <span data-search-phone-target="displayPhone" class="fw-bold"></span>
                </p>
            </div>

            <div class="form-group mb-4">
                <input
                    type="number"
                    data-search-phone-target="otpInput"
                    class="form-control form-control-lg text-center fw-bold"
                    placeholder="000000"
                    style="letter-spacing: 0.5rem; font-size: 2rem;"
                    maxlength="6"
                >
            </div>

            <button
                data-action="click->search-phone#verifyOtp"
                class="btn btn-success btn-lg w-100 mb-3"
                style="border-radius: 12px;"
            >
                Valider le code
            </button>

            <button
                data-action="click->search-phone#resendOtp"
                class="btn btn-link btn-sm text-decoration-none"
            >
                Renvoyer un code
            </button>
        </div>

    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .animate__fadeIn { animation-duration: 0.5s; }
        .input-group-text { border-radius: 12px 0 0 12px; }
        .form-control { border-radius: 12px; }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="module">
        // Import des modules n√©cessaires
        import { PushNotifications } from '@capacitor/push-notifications';
        import { Capacitor } from '@capacitor/core';

        // Fonction de test des notifications (accessible globalement)
        window.testNotificationStatus = async function() {
            const results = [];

            // 1. V√©rifier localStorage
            const fcmToken = localStorage.getItem('fcm_token');
            const deviceId = localStorage.getItem('device_id');

            results.push(`üì± Device ID: ${deviceId ? '‚úÖ Pr√©sent' : '‚ùå Absent'}`);
            results.push(`üîë Token FCM: ${fcmToken ? '‚úÖ Pr√©sent (' + fcmToken.length + ' chars)' : '‚ùå Absent'}`);

            if (fcmToken) {
                results.push(`   Aper√ßu: ${fcmToken.substring(0, 30)}...`);
            }

            // 2. V√©rifier Capacitor
            try {
                results.push(`‚ö° Capacitor: ‚úÖ Charg√©`);
                results.push(`üìç Platform: ${Capacitor.getPlatform()}`);
                results.push(`üîå Native: ${Capacitor.isNativePlatform() ? '‚úÖ Oui' : '‚ö†Ô∏è Non (web)'}`);

                // 3. V√©rifier PushNotifications (si plateforme native)
                if (Capacitor.isNativePlatform()) {
                    try {
                        const permStatus = await PushNotifications.checkPermissions();
                        results.push(`üîî Permissions: ${permStatus.receive}`);

                        if (permStatus.receive === 'denied') {
                            results.push(`   ‚ùå Les notifications sont D√âSACTIV√âES`);
                            results.push(`   üëâ Activer dans: Param√®tres > Apps > ScoutReady > Notifications`);
                        } else if (permStatus.receive === 'prompt') {
                            results.push(`   ‚è∏Ô∏è Permissions non encore demand√©es`);
                            results.push(`   üëâ Elles seront demand√©es lors de la connexion`);
                        } else if (permStatus.receive === 'granted') {
                            results.push(`   ‚úÖ Permissions ACCORD√âES`);
                        }
                    } catch (e) {
                        results.push(`‚ùå Erreur PushNotifications: ${e.message}`);
                    }
                } else {
                    results.push(`üîî Mode web - notifications limit√©es`);
                }

            } catch (e) {
                results.push(`‚ùå Erreur Capacitor: ${e.message}`);
            }

            // 4. V√©rifier les controllers Stimulus
            const firebaseController = document.querySelector('[data-controller~="firebase"]');
            results.push(`üî• Firebase Controller: ${firebaseController ? '‚úÖ Pr√©sent' : '‚ùå Absent'}`);

            // 5. Recommandations
            results.push('');
            results.push('=== RECOMMANDATIONS ===');

            if (!fcmToken && Capacitor.isNativePlatform()) {
                results.push('‚ö†Ô∏è TOKEN MANQUANT - Actions:');
                results.push('1. Red√©marrer l\'application');
                results.push('2. V√©rifier les permissions');
                results.push('3. V√©rifier la connexion internet');
            } else if (fcmToken) {
                results.push('‚úÖ Tout semble OK !');
                results.push('Le token FCM est pr√©sent et pr√™t √† √™tre utilis√©.');
            }

            // Afficher les r√©sultats
            alert(results.join('\n'));

            // Logger dans la console
            console.log('=== DIAGNOSTIC NOTIFICATIONS ===');
            results.forEach(r => console.log(r));

            return {
                fcmToken,
                deviceId,
                platform: Capacitor.getPlatform(),
                isNative: Capacitor.isNativePlatform()
            };
        }
    </script>
{% endblock %}

{% block title %}Connexion{% endblock %}
